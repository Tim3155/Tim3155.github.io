<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nachrichten für 5 Minuten</title>
<style>
body { font-family: Arial, sans-serif; background:#0f1724; color:#cfeffb; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; overflow: hidden;}
h1 { color:#13b6ff; cursor:pointer; }
.btn { cursor:pointer; padding:8px 12px; background:#13b6ff; color:white; border:none; border-radius:6px; margin:6px; transition: background 0.2s; }
.btn:hover { background:#0ea5e9; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#0b1220; padding:20px; border:1px solid #13b6ff; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); width:300px; z-index:2; }
.closeBtn { cursor:pointer; background:#ff4d4d; color:white; border:none; border-radius:50%; width:30px; height:30px; font-weight:bold; font-size:16px; text-align:center; line-height:28px; float:right; margin-top:-10px; margin-right:-10px; transition: background 0.2s; }
.closeBtn:hover { background:#ff1a1a; }
table { margin-top:20px; border-collapse:collapse; width:80%; max-width:500px; display:none; z-index:1; position:relative;}
th,td { border:1px solid #13b6ff; padding:8px; text-align:left; }
#actionBtns { display:none; margin-top:10px; z-index:1; position:relative;}
#warn { color: yellow; font-weight:bold; display:none; margin-top:5px; }
canvas#snowCanvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
</style>
</head>
<body>
<h1 id="playBtn">▶ Klick</h1>

<div class="modal" id="modal">
  <button class="closeBtn" id="closeModal">×</button>
  <h3>Neue Nachricht schreiben</h3>
  <textarea id="msg" rows="3" cols="30" placeholder="Deine Nachricht..."></textarea><br>
  <button class="btn" id="sendBtn">Senden</button>
  <div id="warn">⚠ Du kannst nur eine Nachricht gleichzeitig haben!</div>
</div>

<h2 id="msgHeader" style="display:none;">Nachrichten (5 Minuten sichtbar)</h2>
<table id="msgTable">
  <thead><tr><th>Text</th><th>Verbleibende Zeit</th></tr></thead>
  <tbody id="messages"></tbody>
</table>

<div id="actionBtns">
  <button class="btn" id="newMsgBtn">Neue Nachricht schreiben</button>
</div>

<canvas id="snowCanvas"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ------------------ Firebase Setup ------------------ */
const firebaseConfig = {
  apiKey: "DEIN_API_KEY",
  authDomain: "DEIN_PROJECT.firebaseapp.com",
  databaseURL: "https://DEIN_PROJECT.firebaseio.com",
  projectId: "DEIN_PROJECT_ID",
  storageBucket: "DEIN_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "1:XXXX:web:XXXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ------------------ Nachrichtenscript ------------------ */
const playBtn = document.getElementById('playBtn');
const modal = document.getElementById('modal');
const sendBtn = document.getElementById('sendBtn');
const msgBox = document.getElementById('msg');
const messagesTable = document.getElementById('msgTable');
const msgHeader = document.getElementById('msgHeader');
const closeModal = document.getElementById('closeModal');
const actionBtns = document.getElementById('actionBtns');
const newMsgBtn = document.getElementById('newMsgBtn');
const tbody = document.getElementById('messages');
const warnBox = document.getElementById('warn');

const MESSAGE_DURATION = 5*60*1000;
let hasActiveMessage = false;

const deviceId = localStorage.getItem('deviceId') || 'device_' + Math.random().toString(36).substring(2,10);
if(!localStorage.getItem('deviceId')) localStorage.setItem('deviceId', deviceId);

function addMessageToTable(id, text, timestamp, devId){
  const tr = document.createElement('tr');
  const tdText = document.createElement('td'); tdText.textContent = text;
  const tdTime = document.createElement('td'); tdTime.textContent = '';
  tr.appendChild(tdText); tr.appendChild(tdTime);
  tbody.appendChild(tr);

  // Countdown updaten
  const interval = setInterval(()=>{
    const remaining = MESSAGE_DURATION - (Date.now()-timestamp);
    if(remaining <= 0){
      tr.remove();
      clearInterval(interval);
      if(devId === deviceId) hasActiveMessage = false;
      db.ref("messages/"+id).remove(); // nach 5 min löschen
    } else {
      const m = Math.floor(remaining/60000);
      const s = Math.floor((remaining%60000)/1000);
      tdTime.textContent = `${m}:${s.toString().padStart(2,'0')}`;
    }
  },1000);
}

/* ------------------ Firebase Events ------------------ */
db.ref("messages").on("child_added", snapshot=>{
  const msg = snapshot.val();
  if(Date.now()-msg.timestamp < MESSAGE_DURATION){
    addMessageToTable(snapshot.key, msg.text, msg.timestamp, msg.deviceId);
    if(msg.deviceId === deviceId) hasActiveMessage = true;
  } else {
    snapshot.ref.remove();
  }
});

/* ------------------ UI ------------------ */
playBtn.addEventListener('click', ()=>{
  messagesTable.style.display='table';
  msgHeader.style.display='block';
  actionBtns.style.display='block';
  playBtn.style.display='none';
});

newMsgBtn.addEventListener('click', ()=>{
  if(hasActiveMessage){
    warnBox.style.display = 'block';
    return;
  }
  modal.style.display='block';
  warnBox.style.display='none';
});

sendBtn.addEventListener('click', ()=>{
  const text = msgBox.value.trim();
  if(!text) return;

  if(hasActiveMessage){
    warnBox.style.display='block';
    return;
  }

  const id = db.ref().push().key;
  const msg = {text, timestamp: Date.now(), deviceId};
  db.ref("messages/"+id).set(msg);

  msgBox.value='';
  modal.style.display='none';
  hasActiveMessage = true;
});

closeModal.addEventListener('click', ()=>{
  modal.style.display='none';
  warnBox.style.display='none';
});

/* ------------------ Schneefall ------------------ */
const canvas = document.getElementById('snowCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
});
const numFlakes = 80;
const flakes = [];
for(let i=0;i<numFlakes;i++){
  flakes.push({x: Math.random()*W, y: Math.random()*H, r: Math.random()*3+1, speed: Math.random()*0.5+0.2});
}
function drawFlakes(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = 'rgba(255,255,255,0.7)';
  ctx.beginPath();
  for(let i=0;i<numFlakes;i++){
    const f = flakes[i];
    ctx.moveTo(f.x,f.y);
    ctx.arc(f.x,f.y,f.r,0,Math.PI*2,true);
  }
  ctx.fill();
  updateFlakes();
}
function updateFlakes(){
  for(let i=0;i<numFlakes;i++){
    const f = flakes[i];
    f.y += f.speed;
    if(f.y>H){ f.y=-5; f.x=Math.random()*W; }
  }
}
function animateSnow(){ drawFlakes(); requestAnimationFrame(animateSnow); }
animateSnow();
</script>
</body>
</html>
